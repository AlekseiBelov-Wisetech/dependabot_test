name: .NET Vulnerability Scan

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  vulnerability-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'  # Adjust to your SDK version

      - name: Restore all solutions
        run: |
          find . -name "*.sln" -print0 | while IFS= read -r -d '' sln; do
            echo "üîß Restoring: $sln"
            dotnet restore "$sln"
          done

      - name: Check for vulnerabilities
        run: |
          find . -name "*.sln" -print0 | while IFS= read -r -d '' sln; do
            echo "üîç Scanning: $sln"
            OUTPUT=$(dotnet list "$sln" package --vulnerable)
            echo "$OUTPUT"

            if echo "$OUTPUT" | grep -q "has the following vulnerable packages"; then
              echo "‚ùå Vulnerabilities found in $sln"
              exit 1
            fi
          done
