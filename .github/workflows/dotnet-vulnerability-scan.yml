name: .NET Vulnerability Scan

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  vulnerability-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore all solutions
        run: |
          find . -name "*.sln" -print0 | while IFS= read -r -d '' sln; do
            echo "üîß Restoring: $sln"
            dotnet restore "$sln"
          done

      - name: Check for vulnerabilities
        run: |
          echo "üîç Checking for vulnerable packages..."

          # Temp flag file to track if vulnerabilities are found
          VULN_FLAG=".vuln_found"
          rm -f "$VULN_FLAG"

          find . -name "*.sln" -print0 | while IFS= read -r -d '' sln; do
            echo "üîé Scanning solution: $sln"
            OUTPUT=$(dotnet list "$sln" package --vulnerable)

            echo "$OUTPUT"
            echo ""

            if echo "$OUTPUT" | grep -q "has the following vulnerable packages"; then
              echo "‚ùå Vulnerabilities found in: $sln"
              touch "$VULN_FLAG"
            else
              echo "‚úÖ No vulnerabilities found in: $sln"
            fi

            echo "--------------------------------------"
          done

          if [ -f "$VULN_FLAG" ]; then
            echo "‚ùå Vulnerabilities detected in one or more solutions."
            exit 1
          else
            echo "‚úÖ No vulnerabilities found across all solutions."
          fi
